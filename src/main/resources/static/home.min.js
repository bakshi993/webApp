var widgets = ["#homeWidget", "#bucketsWidget", "#holdingsWidget", "#positionsWidget", "#settingsWidget"];
var tabs = ["#home", "#buckets", "#holdings", "#positions", "#settings", "#mutualFunds"];
var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sept", "Oct", "Nov", "Dec"];
var days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
var date = new Date();
var index = [265, 256265, 260105, 257801, 291849, 264969];

const stompClient = new StompJs.Client({brokerURL: 'ws://localhost:8080/portfolio'});

stompClient.onConnect = (frame) => {
    stompClient.subscribe('/topic/tickers', (tick) => {
        populate(tick);
    });
};

function populate(tick) {
    var content = JSON.parse(tick.body);
    var id = content.instrumentToken;
    var change = content.change.toFixed(2);
    var ltp = content.lastTradedPrice;
    var ltq = content.lastTradedQuantity;
    var bgColor = "red";
    if (change > 0) {
        bgColor = "green";
    }
    $("#ltp-" + id).text(ltp).css("color", bgColor);
    $("#change-" + id).text(change + "%").css("color", bgColor);
    $("#qty-" + id).text(ltq);
}

stompClient.onWebSocketError = (error) => {
    console.error('Error with websocket', error);
};

stompClient.onStompError = (frame) => {
    console.error('Broker reported error: ' + frame.headers['message']);
    console.error('Additional details: ' + frame.body);
};

function hideOtherWidgets(tab) {
    for(var i=0; i < tabs.length; i++) {
        if(tab != tabs[i]) {
            $(widgets[i]).hide();
            $(tabs[i]).css("background-color", "#1a1a1a")
        }
    }
}

function updateMargin() {
    $.get("http://localhost:8080/api/v1/profile/margins", function(data, status) {
      var obj = JSON.parse(JSON.stringify(data));
      $("#margin").text(obj.equity.net);
    });
}

function getMutualFundsHolding() {
    $.get("http://localhost:8080/api/v1/mf/holdings", function(data, status) {
      var obj = JSON.parse(JSON.stringify(data));
      var htmlContent = "<table>";
      for(let i = 0; i < obj.length; i++) {
        htmlContent += "<tr><td>" + obj[i].fund + "</td><td>" + obj[i].quantity + "</td></tr>"
      }
      htmlContent += "</table>";
      $("#mutualFundsWidget").html(htmlContent);
    });
}

function showDefaultWidget() {
    $("#home").css("background-color", "black");
    $("#homeWidget").show();
}

function showCurrentTime() {
    date = new Date();
    var currentDateTime = days[date.getDay()] + " "
        + date.getDate() + " "
        + months[date.getMonth()] + " "
        + date.getHours() + ":"
        + date.getMinutes() + ":"
        + date.getSeconds();
    $("#currentTime").text(currentDateTime);
}

function initPage() {
    stompClient.activate();
    showDefaultWidget();
    showCurrentTime();
    updateMargin();
    setInterval('showCurrentTime()', 1000);
    setInterval('updateMargin()', 60000);
}

$(document).ready(function(){
    initPage();
    getMutualFundsHolding();
    $("#home").click(function() {
        $("#home").css("background-color", "black");
        $("#homeWidget").show();
        hideOtherWidgets("#home");
    });

    $("#buckets").click(function() {
        $("#buckets").css("background-color", "black");
        $("#bucketsWidget").show();
        hideOtherWidgets("#buckets");
    });

    $("#holdings").click(function() {
        $("#holdings").css("background-color", "black");
        $("#holdingsWidget").show();
        hideOtherWidgets("#holdings");
    });

    $("#positions").click(function() {
        $("#positions").css("background-color", "black");
        $("#positionsWidget").show();
        hideOtherWidgets("#positions");
    });

    $("#settings").click(function() {
        $("#settings").css("background-color", "black");
        $("#settingsWidget").show();
        hideOtherWidgets("#settings");
    });
    $("#mutualFunds").click(function() {
        $("#mutualFunds").css("background-color", "black");
        $("#mutualFundsWidget").show();
        hideOtherWidgets("#mutualFunds");
    });
});